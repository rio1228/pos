/*! localsocket v0.7.2 https://github.com/falsandtru/localsocket | (c) 2016, falsandtru | MIT License */
require=function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var d=new Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d}var u=n[a]={exports:{}};t[a][0].call(u.exports,function(e){var n=t[a][1][e];return o(n?n:e)},u,u.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){},{}],2:[function(e,t,n){arguments[4][1][0].apply(n,arguments)},{dup:1}],3:[function(e,t,n){arguments[4][1][0].apply(n,arguments)},{dup:1}],4:[function(e,t,n){"use strict";var r=e("./layer/interface/api");n.default=r.socket,n.socket=r.socket,n.port=r.port,n.status=r.status},{"./layer/interface/api":31}],5:[function(e,t,n){"use strict";function r(e,t){var n=t.schema,r=t.destroy,o=void 0===r?function(){return!0}:r,a=t.expiry,s=void 0===a?1/0:a;return new i.Socket(e,n,o,s)}function o(e,t){var n=t.schema;return new a.Port(e,a.localStorage,n)}var i=e("../domain/indexeddb/api"),a=e("../domain/webstorage/api"),s=e("../domain/indexeddb/api"),c=e("../domain/webstorage/api"),d=e("../domain/webstorage/api");n.status=d.supportWebStorage,n.socket=r,n.port=o;var u;!function(e){e.indexedDB=s.event,e.localStorage=c.events.localStorage,e.sessionStorage=c.events.sessionStorage}(u=n.events||(n.events={}))},{"../domain/indexeddb/api":13,"../domain/webstorage/api":20}],6:[function(e,t,n){"use strict";function r(e){return+e}n.IdNumber=r},{}],7:[function(e,t,n){"use strict";function r(e){return e.length>0&&"_"!==e[0]&&"_"!==e[e.length-1]&&!a.test(e)&&i.test(e)}function o(e){return function(t){switch(typeof e[t]){case"undefined":case"boolean":case"number":case"string":case"object":return!0;default:return!1}}}var i=/^[A-z][0-9A-z_]*$/,a=/^[0-9A-Z_]+$/;n.isValidName=r,n.isValidValue=o},{}],8:[function(e,t,n){"use strict";var r,o=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=e("spica");!function(e){e.id="id",e.key="key",e.type="type",e.attr="attr",e.value="value",e.date="date",e.surrogateKeyDateField="key+date"}(r=n.EventRecordFields||(n.EventRecordFields={}));var a=function(){function e(e,t,r,o){if("number"==typeof this.id&&this.id>0==!1||void 0!==this.id)throw new TypeError("LocalSocket: EventRecord: Invalid event id: "+this.id);if(this.type=o,"string"!=typeof this.type)throw new TypeError("LocalSocket: EventRecord: Invalid event type: "+this.type);if(this.key=e,"string"!=typeof this.key)throw new TypeError("LocalSocket: EventRecord: Invalid event key: "+this.key);if(this.value=t,"object"!=typeof this.value||!this.value)throw new TypeError("LocalSocket: EventRecord: Invalid event value: "+this.value);if(this.date=r,"number"!=typeof this.date||this.date>=0==!1)throw new TypeError("LocalSocket: EventRecord: Invalid event date: "+this.date);if(this.attr=this.type===n.EventType.put?Object.keys(t).reduce(function(e,t){return t.length>0&&"_"!==t[0]&&"_"!==t[t.length-1]?t:e},""):"","string"!=typeof this.attr)throw new TypeError("LocalSocket: EventRecord: Invalid event attr: "+this.key);if(this.type===n.EventType.put&&0===this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);if(this.type!==n.EventType.put&&0!==this.attr.length)throw new TypeError("LocalSocket: EventRecord: Invalid event attr with "+this.type+": "+this.attr);switch(o){case n.EventType.put:return this.value=t=i.clone(new d,(a={},a[this.attr]=t[this.attr],a)),void void Object.freeze(this.value);case n.EventType.snapshot:return this.value=t=i.clone(new d,t),void void Object.freeze(this.value);case n.EventType.delete:return this.value=t=new d,void void Object.freeze(this.value);default:throw new TypeError("LocalSocket: Invalid event type: "+o)}var a}return e}(),s=function(e){function t(t,r,o,i){void 0===o&&(o=n.EventType.put),void 0===i&&(i=Date.now());var a=e.call(this,t,r,i,o)||this;if(a.EVENT_RECORD,void 0!==a.id||"id"in a)throw new TypeError("LocalSocket: UnsavedEventRecord: Invalid event id: "+a.id);return void Object.freeze(a),a}return o(t,e),t}(a);n.UnsavedEventRecord=s;var c=function(e){function t(t,n,r,o,i){var a=e.call(this,n,r,i,o)||this;if(a.id=t,a.EVENT_RECORD,a.id>0==!1)throw new TypeError("LocalSocket: SavedEventRecord: Invalid event id: "+a.id);return void Object.freeze(a),a}return o(t,e),t}(a);n.SavedEventRecord=c,n.EventType={put:"put",delete:"delete",snapshot:"snapshot"};var d=function(){function e(){}return e}();n.EventValue=d},{spica:void 0}],9:[function(e,t,n){"use strict";function r(e,t){function n(e){return e.map(function(e,t){return[e,t]}).sort(function(e,t){var n=e[0],r=e[1],o=t[0],i=t[1];return indexedDB.cmp(n.key,o.key)||o.date-n.date||o.id-n.id||i-r}).reduceRight(function(e,t){var n=e[0],r=e.slice(1),o=t[0],i=n[0];return i?i.key===o.key?a.concat([a.concat([o],n)],r):a.concat([[o]],a.concat([n],r)):[[o]]},[[]])}function r(e,t){switch(t.type){case f.EventType.put:return void 0!==t.value[t.attr]?new d.UnsavedEventRecord(t.key,Object.assign(new f.Value,e.value,t.value),f.EventType.snapshot):new d.UnsavedEventRecord(t.key,Object.keys(e.value).reduce(function(n,r){return r===t.attr?n:(n[r]=e[r],n)},new f.Value),f.EventType.snapshot);case f.EventType.snapshot:return t;case f.EventType.delete:return t}throw new TypeError("LocalSocket: Invalid event type: "+t)}return n(t).map(function(t){return t.reduceRight(r,new d.UnsavedEventRecord(e,new f.Value,f.EventType.delete,0))}).reduce(function(e){return e})}var o=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},a=e("spica"),s=e("../../infrastructure/indexeddb/api"),c=e("../constraint/types"),d=e("../schema/event");n.UnsavedEventRecord=d.UnsavedEventRecord,n.SavedEventRecord=d.SavedEventRecord;var u=e("../schema/event"),v=e("../../../lib/noop"),f=function(){function e(t,n){var r=this;this.database=t,this.name=n,this.memory=new a.Observable,this.events={load:new a.Observable,save:new a.Observable,loss:new a.Observable},this.events_={update:new a.Observable,access:new a.Observable},this.syncState=new Map,this.syncWaits=new a.Observable,this.snapshotCycle=9;var o=new(function(){function e(){this.ids=new Map,this.dates=new Map}return e.prototype.update=function(e){void this.ids.set(e.key,c.IdNumber(Math.max(e.id||0,this.ids.get(e.key)||0))),void this.dates.set(e.key,Math.max(e.date,this.dates.get(e.key)||0))},e}());void this.events_.update.monitor([],function(t){t instanceof d.UnsavedEventRecord||t.date<=o.dates.get(t.key)&&t.id<=o.ids.get(t.key)||void r.events.load.emit([t.key,t.attr,t.type],new e.Event(t.type,t.id,t.key,t.attr,t.date))}),void this.events_.update.monitor([],function(t){void o.update(new e.Event(t.type,t.id||c.IdNumber(0),t.key,t.attr,t.date))}),void this.events.load.monitor([],function(e){return void o.update(e)}),void this.events.save.monitor([],function(e){return void o.update(e)}),void this.events.save.monitor([],function(t){switch(t.type){case e.EventType.delete:case e.EventType.snapshot:void r.clean(t.key)}})}return e.configure=function(e){return{make:function(t){var n=t.objectStoreNames.contains(e)?t.transaction(e).objectStore(e):t.createObjectStore(e,{keyPath:d.EventRecordFields.id,autoIncrement:!0});return n.indexNames.contains(d.EventRecordFields.id)||void n.createIndex(d.EventRecordFields.id,d.EventRecordFields.id,{unique:!0}),n.indexNames.contains(d.EventRecordFields.key)||void n.createIndex(d.EventRecordFields.key,d.EventRecordFields.key),n.indexNames.contains(d.EventRecordFields.type)||void n.createIndex(d.EventRecordFields.type,d.EventRecordFields.type),n.indexNames.contains(d.EventRecordFields.attr)||void n.createIndex(d.EventRecordFields.attr,d.EventRecordFields.attr),n.indexNames.contains(d.EventRecordFields.value)||void n.createIndex(d.EventRecordFields.value,d.EventRecordFields.value),n.indexNames.contains(d.EventRecordFields.date)||void n.createIndex(d.EventRecordFields.date,d.EventRecordFields.date),n.indexNames.contains(d.EventRecordFields.surrogateKeyDateField)||void n.createIndex(d.EventRecordFields.surrogateKeyDateField,[d.EventRecordFields.key,d.EventRecordFields.date]),!0},verify:function(t){return t.objectStoreNames.contains(e)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.id)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.key)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.type)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.attr)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.value)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.date)&&t.transaction(e).objectStore(e).indexNames.contains(d.EventRecordFields.surrogateKeyDateField)},destroy:function(){return!0}}},e.prototype.update=function(e,t,n){return"string"==typeof n&&"string"==typeof t?void this.memory.emit([e,t,n]):"string"==typeof t?void this.memory.emit([e,t]):void this.memory.emit([e])},e.prototype.sync=function(e,t){var n=this;return void 0===t&&(t=v.noop),void e.map(function(e){switch(n.syncState.get(e)){case!0:return Promise.resolve();case!1:return new Promise(function(t){return void void n.syncWaits.once([e],function(n){return void t(n?[e,n]:void 0)})});default:return new Promise(function(t){return void n.syncWaits.once([e],function(n){return void t(n?[e,n]:void 0)}),void void n.fetch(e,function(t){return void n.syncWaits.emit([e],t)})})}}).reduce(function(e,t){return e.then(function(e){return t.then(function(t){return e.concat([t])})})},Promise.resolve([])).then(function(e){return void t(e.filter(function(e){return!!e}))})},e.prototype.fetch=function(t,n,r){var o=this;void 0===n&&(n=v.noop),void 0===r&&(r=v.noop),void this.syncState.set(t,this.syncState.get(t)===!0);var i=[];return void s.listen(this.database)(function(u){var v=u.transaction(o.name,r?s.IDBTransactionMode.readwrite:s.IDBTransactionMode.readonly),f=v.objectStore(o.name).index(d.EventRecordFields.key).openCursor(t,s.IDBCursorDirection.prev),y=function(){f.onsuccess=v.onerror=v.onabort=null},h=function(s,u){if(u)return void n(u),void y(),void r(v,u);if(!s||s.value.date<o.meta(t).date)return void Array.from(i.reduceRight(function(t,n){return 0===t.length||t[0].type===e.EventType.put?a.concat(t,[n]):t},[]).reduceRight(function(e,t){return e.set(t.attr,t)},new Map).values()).sort(function(e,t){return e.date-t.date||e.id-t.id}).forEach(function(e){void o.memory.on([e.key,e.attr,a.sqid(e.id)],function(){return e}),void o.memory.once([e.key],function(){throw void o.events_.update.emit([e.key,e.attr,a.sqid(e.id)],e)})}),void o.syncState.set(t,!0),void n(),void y(),void r(v),void o.update(t),void o.events_.access.emit([t],new l(p.query,c.IdNumber(0),t,"")),void(i.length>=o.snapshotCycle&&void o.snapshot(t));var f=s.value;return o.memory.refs([f.key,f.attr,a.sqid(f.id)]).length>0?void h(null,u):(void i.unshift(new d.SavedEventRecord(f.id,f.key,f.value,f.type,f.date)),f.type!==e.EventType.put?void h(null,u):void s.continue())};f.onsuccess=function(){return void h(f.result,f.error)},v.onerror=v.onabort=function(){return void n(v.error)}})},e.prototype.transaction=function(e,t,n,r){var o=this;void setTimeout(function(){return void o.fetch(e,v.noop,function(e,i){try{if(i)throw i;o.tx=e,void t(),void e.addEventListener("complete",function(){return void n()}),void e.addEventListener("abort",function(){return void r(e.error)}),void e.addEventListener("error",function(){return void r(e.error)})}catch(e){e=e instanceof Error||e instanceof DOMError?e:new Error,void r(e)}finally{o.tx=void 0}})})},e.prototype.keys=function(){return this.memory.reflect([]).reduce(function(e,t){return 0===e.length||e[e.length-1]!==t.key?a.concat(e,[t.key]):e},[]).sort()},e.prototype.meta=function(e){var t=this.memory.reflect([e]);return Object.freeze({key:e,id:t.reduce(function(e,t){return t.id>e?t.id:e},0),date:t.reduce(function(e,t){return t.date>e?t.date:e},0)})},e.prototype.has=function(t){return r(t,this.memory.reflect([t])).type!==e.EventType.delete},e.prototype.get=function(e){return this.syncState.get(e)||void this.fetch(e),void this.events_.access.emit([e],new l(p.query,c.IdNumber(0),e,"")),r(e,this.memory.reflect([e])).value},e.prototype.add=function(t,n){var r=this;if(void 0===n&&(n=this.tx),void this.events_.access.emit([t.key,t.attr,t.type],new l(t.type,c.IdNumber(0),t.key,t.attr)),!(t instanceof d.UnsavedEventRecord))throw new Error("LocalSocket: Cannot add a saved event: "+JSON.stringify(t));switch(this.syncState.get(t.key)||void this.fetch(t.key),t.type){case e.EventType.put:void this.memory.off([t.key,t.attr,a.sqid(0)]);break;case e.EventType.delete:case e.EventType.snapshot:void this.memory.refs([t.key]).filter(function(e){var t=e[0],n=t[2];return n===a.sqid(0)}).reduce(function(e,t){var n=t[0],r=n[0],o=n[1],i=n[2];return e.set(r,[r,o,i])},new Map).forEach(function(e){return void r.memory.off(e)})}var o=this.memory.on([t.key,t.attr,a.sqid(0),a.sqid()],function(){return t});return void this.memory.once([t.key,t.attr,a.sqid(0)],function(){throw void r.events_.update.emit([t.key,t.attr,a.sqid(0)],t)}),void this.update(t.key,t.attr,a.sqid(0)),void new Promise(function(u,v){var f=function(n){var s=function(){return r.memory.refs([t.key,t.attr,a.sqid(0)]).some(function(e){var n=e[1];return n(void 0)===t})};if(!s())return void u();var f=n.objectStore(r.name).add(i({},t));n.oncomplete=function(){void o();var n=new d.SavedEventRecord(c.IdNumber(f.result),t.key,t.value,t.type,t.date);void r.memory.on([n.key,n.attr,a.sqid(n.id)],function(){return n}),void r.memory.once([n.key,n.attr,a.sqid(n.id)],function(){throw void r.events_.update.emit([n.key,n.attr,a.sqid(n.id)],n)}),void r.events.save.emit([n.key,n.attr,n.type],new e.Event(n.type,n.id,n.key,n.attr,t.date)),void r.update(n.key,n.attr,a.sqid(n.id)),void u(),r.memory.refs([n.key]).filter(function(e){var t=e[1];return t(void 0)instanceof d.SavedEventRecord}).length>=r.snapshotCycle&&void r.snapshot(n.key)},n.onerror=n.onabort=function(){return s()?void v():void u()}};if(n)return void f(n);var p=new a.Cancelable;void p.listeners.add(v),void setTimeout(function(){return void setTimeout(p.cancel,1e3),void s.listen(r.database)(function(e){return void p.listeners.clear(),void p.maybe(e).fmap(function(e){return void f(e.transaction(r.name,s.IDBTransactionMode.readwrite))}).extract(function(){})})})}).catch(function(){return void r.events.loss.emit([t.key,t.attr,t.type],new e.Event(t.type,c.IdNumber(0),t.key,t.attr,t.date))})},e.prototype.delete=function(t){return void this.add(new d.UnsavedEventRecord(t,new e.Value,e.EventType.delete))},e.prototype.snapshot=function(t){var n=this;return void s.listen(this.database)(function(o){if(n.syncState.get(t)){var i=o.transaction(n.name,s.IDBTransactionMode.readwrite),a=i.objectStore(n.name),c=a.index(d.EventRecordFields.key).openCursor(t,s.IDBCursorDirection.prev),u=[];c.onsuccess=function(){var o=c.result;if(o){var a=o.value;void u.unshift(new d.SavedEventRecord(a.id,a.key,a.value,a.type,a.date))}if(o)return void o.continue();if(0!==u.length){var s=r(t,u);if(!(s instanceof d.SavedEventRecord)){switch(s.type){case e.EventType.snapshot:return void n.add(new d.UnsavedEventRecord(s.key,s.value,s.type,u.reduce(function(e,t){return t.date>e?t.date:e},0)),i);case e.EventType.delete:return}throw new TypeError("LocalSocket: Invalid event type: "+s.type)}}}}})},e.prototype.clean=function(t){var n=this,r=[],o=new Map;return void this.cursor(t?s.IDBKeyRange.bound(t,t):s.IDBKeyRange.upperBound(1/0),t?d.EventRecordFields.key:d.EventRecordFields.date,s.IDBCursorDirection.prev,s.IDBTransactionMode.readwrite,function(t){if(t){var i=t.value;switch(i.type){case e.EventType.put:void o.set(i.key,o.get(i.key)||!1);break;case e.EventType.snapshot:if(!o.get(i.key))return void o.set(i.key,!0),void void t.continue();break;case e.EventType.delete:void o.set(i.key,!0)}return o.get(i.key)&&(void t.delete(),void r.unshift(i)),void t.continue()}return void r.reduce(function(e,t){return void n.memory.off([t.key,t.attr,a.sqid(t.id)])},void 0)})},e.prototype.cursor=function(e,t,n,r,o){var i=this;return void s.listen(this.database)(function(a){var s=a.transaction(i.name,r),c=t?s.objectStore(i.name).index(t).openCursor(e,n):s.objectStore(i.name).openCursor(e,n);c.onsuccess=function(){return c.result&&void o(c.result,c.error)},s.oncomplete=function(){return void o(null,s.error)},s.onerror=s.onabort=function(){return void o(null,s.error)}})},e}();f.fields=Object.freeze(d.EventRecordFields),n.EventStore=f,function(e){e.EventType=u.EventType;var t=function(){function e(e,t,n,r,o){this.type=e,this.id=t,this.key=n,this.attr=r,this.date=o,void Object.freeze(this)}return e}();e.Event=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t}(d.UnsavedEventRecord);e.Record=n;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t}(u.EventValue);e.Value=r}(f=n.EventStore||(n.EventStore={})),n.EventStore=f;var p=i({},f.EventType,{query:"query"}),l=function(){function e(e,t,n,r){this.type=e,this.id=t,this.key=n,this.attr=r,void Object.freeze(this)}return e}();n.compose=r},{"../../../lib/noop":32,"../../infrastructure/indexeddb/api":24,"../constraint/types":6,"../schema/event":8,spica:void 0}],10:[function(e,t,n){"use strict";var r=e("spica"),o=e("../../infrastructure/indexeddb/api"),i=e("../../../lib/noop"),a=function(){function e(e,t,n){if(this.database=e,this.name=t,this.index=n,this.cache=new Map,this.events={access:new r.Observable},"string"!=typeof n)throw new TypeError}return e.configure=function(){return{make:function(){return!0},verify:function(){return!0},destroy:function(){return!0}}},e.prototype.get=function(t,n){var r=this;return void 0===n&&(n=i.noop),void this.events.access.emit([t],[[t],e.EventType.get]),void o.listen(this.database)(function(e){var i,a=e.transaction(r.name,o.IDBTransactionMode.readonly),s=r.index?a.objectStore(r.name).index(r.index).get(t):a.objectStore(r.name).get(t);s.onsuccess=function(){return i=void 0!==s.result&&null!==s.result?s.result:r.cache.get(t)},a.oncomplete=function(){return n(i,a.error)},a.onerror=a.onabort=function(){return n(void 0,a.error)}}),this.cache.get(t)},e.prototype.set=function(e,t,n){return void 0===n&&(n=i.noop),this.put(t,e,n)},e.prototype.put=function(t,n,r){var a=this;return void 0===r&&(r=i.noop),void this.cache.set(n,t),void this.events.access.emit([n],[[n],e.EventType.put]),void o.listen(this.database)(function(e){if(a.cache.has(n)){var t=e.transaction(a.name,o.IDBTransactionMode.readwrite);a.index?t.objectStore(a.name).put(a.cache.get(n)):t.objectStore(a.name).put(a.cache.get(n),n),t.oncomplete=t.onerror=t.onabort=function(){return void r(n,t.error)}}}),this.cache.get(n)},e.prototype.delete=function(t,n){var r=this;void 0===n&&(n=i.noop),void this.cache.delete(t),void this.events.access.emit([t],[[t],e.EventType.delete]),void o.listen(this.database)(function(e){var i=e.transaction(r.name,o.IDBTransactionMode.readwrite);void i.objectStore(r.name).delete(t),i.oncomplete=i.onerror=i.onabort=function(){return void n(i.error)}})},e.prototype.cursor=function(e,t,n,r,i){var a=this;void o.listen(this.database)(function(o){var s=o.transaction(a.name,r),c=t?s.objectStore(a.name).index(t).openCursor(e,n):s.objectStore(a.name).openCursor(e,n);c.onsuccess=function(){return c.result&&void i(c.result,c.error)},s.oncomplete=function(){return void i(null,s.error)},s.onerror=s.onabort=function(){return void i(null,s.error)}})},e}();n.KeyValueStore=a,function(e){e.EventType={get:"get",put:"put",delete:"delete"}}(a=n.KeyValueStore||(n.KeyValueStore={})),n.KeyValueStore=a},{"../../../lib/noop":32,"../../infrastructure/indexeddb/api":24,spica:void 0}],11:[function(e,t,n){"use strict";var r=e("./module/builder");n.SCHEMA=r.SCHEMA,n.build=r.build,n.isValidPropertyName=r.isValidPropertyName,n.isValidPropertyValue=r.isValidPropertyValue},{"./module/builder":12}],12:[function(e,t,n){"use strict";function r(e,t,r){void 0===r&&(r=i.noop);var a=t();if(void Object.keys(n.SCHEMA).map(function(e){return n.SCHEMA[e].NAME}).reduce(function(e,t){delete a[t]},void 0),"string"!=typeof e[n.SCHEMA.KEY.NAME])throw new TypeError("LocalSocket: Invalid key: "+e[n.SCHEMA.KEY.NAME]);var s=Object.assign(Object.keys(a).filter(o.isValidName).filter(o.isValidValue(a)).reduce(function(t,n){var i=Object.getOwnPropertyDescriptor(a,n);if(i&&(i.get||i.set))return t;var s=a[n];return void 0===e[n]&&(e[n]=s),t[n]={enumerable:!0,get:function(){return void 0===e[n]?s:e[n]},set:function(t){var i=e[n];o.isValidValue(e)(n)&&(e[n]=void 0===t?s:t,void r(n,t,i))}},t},{}),(c={},c[n.SCHEMA.META.NAME]={configurable:!1,enumerable:!1,get:function(){return e[n.SCHEMA.META.NAME]}},c[n.SCHEMA.ID.NAME]={configurable:!1,enumerable:!1,get:function(){return e[n.SCHEMA.ID.NAME]}},c[n.SCHEMA.KEY.NAME]={configurable:!1,enumerable:!1,get:function(){return e[n.SCHEMA.KEY.NAME]}},c[n.SCHEMA.DATE.NAME]={configurable:!1,enumerable:!1,get:function(){return e[n.SCHEMA.DATE.NAME]}},c[n.SCHEMA.EVENT.NAME]={configurable:!1,enumerable:!1,get:function(){return e[n.SCHEMA.EVENT.NAME]}},c));return void Object.defineProperties(a,s),void Object.seal(a),a;var c}var o=e("../../../data/constraint/values");n.isValidPropertyName=o.isValidName,n.isValidPropertyValue=o.isValidValue;var i=e("../../../../lib/noop");n.SCHEMA={META:{NAME:"__meta"},ID:{NAME:"__id"},KEY:{NAME:"__key"},DATE:{NAME:"__date"},EVENT:{NAME:"__event"}},n.build=r},{"../../../../lib/noop":32,"../../../data/constraint/values":7}],13:[function(e,t,n){"use strict";var r=e("./service/socket");n.Socket=r.Socket;var o=e("./service/event");n.event=o.event,n.IDBEventType=o.IDBEventType},{"./service/event":18,"./service/socket":19}],14:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),o=e("spica"),i=e("../../../infrastructure/indexeddb/api"),a=e("./socket/data"),s=e("./socket/access"),c=e("./socket/expiry"),d=e("../../../../lib/noop"),u=new Map,v=function(){function e(e,t,n){var r=this;return this.name=e,this.expiry=n,this.events={load:new o.Observable,save:new o.Observable,loss:new o.Observable},this.expiries=new Map,u.has(e)?u.get(e):(void u.set(e,this),void i.open(e,{make:function(e){return a.DataStore.configure().make(e)&&s.AccessStore.configure().make(e)&&c.ExpiryStore.configure().make(e)},verify:function(e){return a.DataStore.configure().verify(e)&&s.AccessStore.configure().verify(e)&&c.ExpiryStore.configure().verify(e)},destroy:function(e,n){return a.DataStore.configure().destroy(e,n)&&s.AccessStore.configure().destroy(e,n)&&c.ExpiryStore.configure().destroy(e,n)&&t(e,n)}}),this.schema=new f(this,this.expiries),void void i.event.on([e,i.IDBEventType.destroy],function(){return void r.schema.bind()}))}return e.prototype.sync=function(e,t){return void 0===t&&(t=d.noop),this.schema.data.sync(e,t)},e.prototype.transaction=function(e,t,n,r){return this.schema.data.transaction(e,t,n,r)},e.prototype.meta=function(e){return this.schema.data.meta(e)},e.prototype.has=function(e){return this.schema.data.has(e)},e.prototype.get=function(e){return this.schema.data.get(e)},e.prototype.add=function(e){return this.schema.data.add(e)},e.prototype.delete=function(e){return this.schema.data.delete(e)},e.prototype.expire=function(e,t){if(void 0===t&&(t=this.expiry),t!==1/0)return void this.expiries.set(e,t)},e.prototype.recent=function(e,t){var n=[];return void this.schema.access.cursor(null,s.AccessStore.fields.date,i.IDBCursorDirection.prev,i.IDBTransactionMode.readonly,function(r,o){return r?void(--e<0||(void n.push(r.primaryKey),void r.continue())):void t(n,o)})},e.prototype.close=function(){return void u.delete(this.name),void i.close(this.name)},e.prototype.destroy=function(){return void i.event.off([this.name,i.IDBEventType.destroy]),void u.delete(this.name),void i.destroy(this.name)},e}();n.SocketStore=v,function(e){e.EventType=a.DataStore.EventType;var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(a.DataStore.Event);e.Event=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(a.DataStore.Record);e.Record=n;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(a.DataStore.Value);e.Value=o}(v=n.SocketStore||(n.SocketStore={})),n.SocketStore=v;var f=function(){function e(e,t){this.store_=e,this.expiries_=t,void this.bind()}return e.prototype.bind=function(){var e=this,t=this.data?this.data.keys():[];this.data=new a.DataStore(this.store_.name),this.data.events.load.monitor([],function(t){return e.store_.events.load.emit([t.key,t.attr,t.type],t)}),this.data.events.save.monitor([],function(t){return e.store_.events.save.emit([t.key,t.attr,t.type],t)}),this.data.events.loss.monitor([],function(t){return e.store_.events.loss.emit([t.key,t.attr,t.type],t)}),this.access=new s.AccessStore(this.store_.name,this.data.events_.access),this.expire=new c.ExpiryStore(this.store_.name,this.store_,this.data.events_.access,this.expiries_),void this.data.sync(t)},e}()},{"../../../../lib/noop":32,"../../../infrastructure/indexeddb/api":24,"./socket/access":15,"./socket/data":16,"./socket/expiry":17,spica:void 0}],15:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),o=e("../../../../data/store/key-value"),i=e("../../../../data/store/event");n.STORE_NAME="access";var a=function(e){function t(r,o){var a=e.call(this,r,n.STORE_NAME,t.fields.key)||this;return void Object.freeze(a),void o.monitor([],function(e){var t=e.key,n=e.type;return n===i.EventStore.EventType.delete?void a.delete(t):void a.set(t,new s(t,Date.now()))}),a}return r(t,e),t.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(n.STORE_NAME)?e.transaction(n.STORE_NAME).objectStore(n.STORE_NAME):e.createObjectStore(n.STORE_NAME,{keyPath:t.fields.key,autoIncrement:!1});return r.indexNames.contains(t.fields.key)||void r.createIndex(t.fields.key,t.fields.key,{unique:!0}),r.indexNames.contains(t.fields.date)||void r.createIndex(t.fields.date,t.fields.date),!0},verify:function(e){return e.objectStoreNames.contains(n.STORE_NAME)&&e.transaction(n.STORE_NAME).objectStore(n.STORE_NAME).indexNames.contains(t.fields.key)&&e.transaction(n.STORE_NAME).objectStore(n.STORE_NAME).indexNames.contains(t.fields.date)},destroy:function(){return!0}}},t}(o.KeyValueStore);a.fields=Object.freeze({key:"key",date:"date"}),n.AccessStore=a;var s=function(){function e(e,t){this.key=e,this.date=t}return e}()},{"../../../../data/store/event":9,"../../../../data/store/key-value":10}],16:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),o=e("../../../../data/store/event");n.STORE_NAME="data";var i=function(e){function t(t){var r=e.call(this,t,n.STORE_NAME)||this;return void Object.freeze(r),r}return r(t,e),t.configure=function(){return o.EventStore.configure(n.STORE_NAME)},t}(o.EventStore);n.DataStore=i,function(e){e.EventType=o.EventStore.EventType;var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(o.EventStore.Event);e.Event=t;var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(o.EventStore.Record);e.Record=n;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(o.EventStore.Value);e.Value=i}(i=n.DataStore||(n.DataStore={})),n.DataStore=i},{"../../../../data/store/event":9}],17:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),o=e("../../../../infrastructure/indexeddb/api"),i=e("../../../../data/store/key-value"),a=e("../../../../data/store/event");n.STORE_NAME="expiry";var s=function(e){function t(r,i,s,d){var u=e.call(this,r,n.STORE_NAME,t.fields.key)||this;void Object.freeze(u);var v=0,f=1/0,p=function(e){f<e||(void clearTimeout(v),f=e,v=setTimeout(function(){f=1/0,void u.cursor(null,t.fields.expiry,o.IDBCursorDirection.next,o.IDBTransactionMode.readonly,function(e){if(e){var t=e.value;return t.expiry>Date.now()?void p(t.expiry):(void i.delete(t.key),void e.continue())}})},e-Date.now()),void o.event.once([r,o.IDBEventType.destroy],function(){return void clearTimeout(v)}))};return void p(Date.now()),void s.monitor([],function(e){var t=e.key,n=e.type;switch(n){case a.EventStore.EventType.delete:return void u.delete(t);default:if(!d.has(t))return;var r=Date.now()+d.get(t);return void u.set(t,new c(t,r)),void p(r)}}),u}return r(t,e),t.configure=function(){return{make:function(e){var r=e.objectStoreNames.contains(n.STORE_NAME)?e.transaction(n.STORE_NAME).objectStore(n.STORE_NAME):e.createObjectStore(n.STORE_NAME,{keyPath:t.fields.key,autoIncrement:!1});return r.indexNames.contains(t.fields.key)||void r.createIndex(t.fields.key,t.fields.key,{unique:!0}),r.indexNames.contains(t.fields.expiry)||void r.createIndex(t.fields.expiry,t.fields.expiry),!0},verify:function(e){return e.objectStoreNames.contains(n.STORE_NAME)&&e.transaction(n.STORE_NAME).objectStore(n.STORE_NAME).indexNames.contains(t.fields.key)&&e.transaction(n.STORE_NAME).objectStore(n.STORE_NAME).indexNames.contains(t.fields.expiry)},destroy:function(){return!0}}},t}(i.KeyValueStore);s.fields=Object.freeze({key:"key",expiry:"expiry"}),n.ExpiryStore=s;var c=function(){function e(e,t){this.key=e,this.expiry=t}return e}()},{"../../../../data/store/event":9,"../../../../data/store/key-value":10,"../../../../infrastructure/indexeddb/api":24}],18:[function(e,t,n){"use strict";var r=e("../../../infrastructure/indexeddb/api");n.event=r.event,n.IDBEventType=r.IDBEventType},{"../../../infrastructure/indexeddb/api":24}],19:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),o=e("spica"),i=e("../../dao/api"),a=e("../model/socket"),s=e("../../../infrastructure/webstorage/api"),c=e("../../webstorage/api"),d=new WeakSet,u=function(){function e(e,t,n){this.key=e,this.attr=t,this.date=n,void Object.freeze(this);
}return e}(),v=function(){function e(){this.msgs=[],this.msgLatestUpdates_=new Map}return e.prototype.recv=function(){var e=this;return this.msgs.filter(function(t){var n=t.date<=e.msgLatestUpdates_.get(t.key);return void e.msgLatestUpdates_.set(t.key,t.date),!n}).map(function(e){return e.key})},e.prototype.send=function(e){this.msgs=this.msgs.reduceRight(function(e,t){return t.key===e[0].key||t.date<e[0].date-1e6?e:o.concat([t],e)},[e]).slice(-9)},e}(),f=function(e){function t(t,n,r,o){void 0===r&&(r=function(){return!0}),void 0===o&&(o=1/0);var f=e.call(this,t,r,o)||this;return f.factory=n,f.port=new c.Port(f.name,s.localStorage,function(){return new v}),f.links=new Map,f.sources=new Map,d.has(f)?f:(void d.add(f),void f.port.link().__event.on([c.WebStorageEventType.recv,"msgs"],function(){return void f.port.link().recv().reduce(function(e,t){return void f.schema.data.fetch(t)},void 0)}),void f.events.save.monitor([],function(e){var t=e.key,n=e.attr;return void f.port.link().send(new u(t,n,Date.now()))}),void f.events.load.monitor([],function(e){var t=e.key,n=e.attr,r=e.type,o=f.sources.get(t);if(o)switch(r){case a.SocketStore.EventType.put:var s=o[n],d=f.get(t)[n];return o[n]=d,void void o.__event.emit([c.WebStorageEventType.recv,n],new c.WebStorageEvent(c.WebStorageEventType.recv,t,n,d,s));case a.SocketStore.EventType.delete:var u=f.get(t);return void void Object.keys(u).filter(i.isValidPropertyName).filter(i.isValidPropertyValue(u)).sort().reduce(function(e,n){var r=o[n],i=void 0;o[n]=i,void o.__event.emit([c.WebStorageEventType.recv,n],new c.WebStorageEvent(c.WebStorageEventType.recv,t,n,i,r))},void 0);case a.SocketStore.EventType.snapshot:var v=f.get(t);return void void Object.keys(v).filter(i.isValidPropertyName).filter(i.isValidPropertyValue(v)).sort().reduce(function(e,n){var r=o[n],i=v[n];o[n]=i,void o.__event.emit([c.WebStorageEventType.recv,n],new c.WebStorageEvent(c.WebStorageEventType.recv,t,n,i,r))},void 0)}}),void Object.seal(f),f)}return r(t,e),t.prototype.link=function(e,t){var n=this;return void this.expire(e,t),this.links.has(e)?this.links.get(e):this.links.set(e,i.build(Object.defineProperties((void this.sources.set(e,o.clone({},this.get(e))),this.sources.get(e)),{__meta:{get:function(){return n.meta(e)}},__id:{get:function(){return this.__meta.id}},__key:{get:function(){return this.__meta.key}},__date:{get:function(){return this.__meta.date}},__event:{value:new o.Observable},__transaction:{value:function(t,r,o){return n.transaction(e,t,r,o)}}}),this.factory,function(t,r,o){return void n.add(new a.SocketStore.Record(e,(i={},i[t]=r,i))),void n.sources.get(e).__event.emit([c.WebStorageEventType.send,t],new c.WebStorageEvent(c.WebStorageEventType.send,e,t,r,o));var i})).get(e)},t.prototype.destroy=function(){void this.port.destroy(),void d.delete(this),void e.prototype.destroy.call(this)},t}(a.SocketStore);n.Socket=f},{"../../../infrastructure/webstorage/api":28,"../../dao/api":11,"../../webstorage/api":20,"../model/socket":14,spica:void 0}],20:[function(e,t,n){"use strict";var r=e("../../infrastructure/webstorage/api");n.localStorage=r.localStorage,n.sessionStorage=r.sessionStorage,n.supportWebStorage=r.supportWebStorage;var o=e("./service/event");n.events=o.events;var i=e("./service/port");n.Port=i.Port,n.WebStorageEvent=i.PortEvent,n.WebStorageEventType=i.PortEventType},{"../../infrastructure/webstorage/api":28,"./service/event":22,"./service/port":23}],21:[function(e,t,n){"use strict";var r=function(){function e(){this.store=new Map}return Object.defineProperty(e.prototype,"length",{get:function(){return this.store.size},enumerable:!0,configurable:!0}),e.prototype.getItem=function(e){return this.store.has(e)?this.store.get(e):null},e.prototype.setItem=function(e,t){void this.store.set(e,t)},e.prototype.removeItem=function(e){void this.store.delete(e)},e.prototype.clear=function(){void this.store.clear()},e}();n.fakeStorage=new r},{}],22:[function(e,t,n){"use strict";function r(e){var t=new o.Observable;return void e.on(["storage"],function(e){return void t.emit([e.key],e)}),t}var o=e("spica"),i=e("../../../infrastructure/webstorage/api");n.events={localStorage:r(i.events.localStorage),sessionStorage:r(i.events.sessionStorage)}},{"../../../infrastructure/webstorage/api":28,spica:void 0}],23:[function(e,t,n){"use strict";function r(e){try{return JSON.parse(e||"{}")||{}}catch(e){return{}}}var o,i=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},a=e("spica"),s=e("../../dao/api"),c=e("../service/event"),d=e("../../../infrastructure/webstorage/api"),u=e("../model/storage"),v=new Map;!function(e){e.send="send",e.recv="recv"}(o=n.PortEventType||(n.PortEventType={}));var f=function(){function e(e,t,n,r,o){this.type=e,this.key=t,this.attr=n,this.newValue=r,this.oldValue=o,void Object.freeze(this)}return e}();n.PortEvent=f;var p=function(){function e(e,t,n,p){void 0===t&&(t=d.sessionStorage||u.fakeStorage),void 0===p&&(p={update:function(e){},delete:function(e){}});var l=this;if(this.name=e,this.storage=t,this.factory=n,this.log=p,this.eventSource=this.storage===d.localStorage?c.events.localStorage:c.events.sessionStorage,this.events={send:new a.Observable,recv:new a.Observable},v.has(e))return v.get(e);void v.set(e,this);var y=i((E={},E[s.SCHEMA.KEY.NAME]=this.name,E[s.SCHEMA.EVENT.NAME]=new a.Observable,E),r(this.storage.getItem(this.name)));this.link_=s.build(y,this.factory,function(e,t,n){void l.log.update(l.name),void l.storage.setItem(l.name,JSON.stringify(Object.keys(y).filter(s.isValidPropertyName).filter(s.isValidPropertyValue(y)).reduce(function(e,t){return e[t]=y[t],e},{})));var r=new f(o.send,l.name,e,t,n);void y.__event.emit([r.type,r.attr],r),void l.events.send.emit([r.attr],r)});var h=function(e){var t=e.newValue,n=r(t);void Object.keys(n).filter(s.isValidPropertyName).filter(s.isValidPropertyValue(n)).reduce(function(e,t){var r=y[t],i=n[t];if(i!==r){y[t]=i;var a=new f(o.recv,l.name,t,i,r);void y.__event.emit([a.type,a.attr],a),void l.events.recv.emit([a.attr],a)}},void 0)};void this.eventSource.on([this.name],h),void this.log.update(this.name),void Object.freeze(this);var E}return e.prototype.link=function(){return this.link_},e.prototype.destroy=function(){void this.eventSource.off([this.name]),void this.storage.removeItem(this.name),void this.log.delete(this.name),void v.delete(this.name)},e}();n.Port=p},{"../../../infrastructure/webstorage/api":28,"../../dao/api":11,"../model/storage":21,"../service/event":22,spica:void 0}],24:[function(e,t,n){"use strict";var r=e("./module/global");n.indexedDB=r.indexedDB,n.IDBKeyRange=r.IDBKeyRange,n.IDBTransactionMode=r.IDBTransactionMode,n.IDBCursorDirection=r.IDBCursorDirection;var o=e("./model/access");n.open=o.open,n.listen=o.listen,n.close=o.close,n.destroy=o.destroy,n.event=o.event;var i=e("./model/event");n.IDBEvent=i.IDBEvent,n.IDBEventType=i.IDBEventType},{"./model/access":25,"./model/event":26,"./module/global":27}],25:[function(e,t,n){"use strict";function r(e,t){void l.set(e,0),void p.set(e,t),h.has(e)||void s(new y.Initial(e))}function o(e){return function(t){var n=E.get(e)||E.set(e,[]).get(e);if(void n.push(t),h.has(e)){var r=h.get(e);r instanceof y.Success&&void r.drain()}}}function i(e){if(void l.set(e,1),void p.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!1}}),!h.has(e))return void s(new y.Initial(e));var t=h.get(e);t instanceof y.Success&&t.end()}function a(e){if(void l.set(e,2),void p.set(e,{make:function(){return!1},verify:function(){return!1},destroy:function(){return!0}}),!h.has(e))return void s(new y.Initial(e));var t=h.get(e);t instanceof y.Success&&t.destroy()}function s(e,t){function n(e){var t=e.database;void v.emit([t,u.IDBEventType.block],new u.IDBEvent(u.IDBEventType.block,t))}function r(e){var t=e.database,n=e.session,r=n.transaction.db,a=p.get(t),s=a.make,d=a.destroy;try{s(r)?(n.onsuccess=function(){return void o(new y.Success(t,r))},n.onerror=function(e){return void i(new y.Error(t,n.error,e))}):n.onsuccess=n.onerror=function(e){return void r.close(),d(n.error,e)?void f(new y.Destroy(t)):void m(new y.End(t))}}catch(e){void c(new y.Crash(t,e))}}function o(e){var t=e.database,n=e.connection,r=function(){return n.onversionchange=function(){return void n.close()},n.onerror=void 0,n.onabort=void 0,n.onclose=void 0};switch(n.onversionchange=function(o){var i=o.newVersion;void r(),void n.close(),i||(void E.delete(t),void v.emit([t,u.IDBEventType.destroy],new u.IDBEvent(u.IDBEventType.destroy,t))),h.get(t)===e&&void m(new y.End(t))},n.onerror=function(e){return void r(),void i(new y.Error(t,e.target.error,e))},n.onabort=function(e){return void r(),void a(new y.Abort(t,e.target.error,e))},n.onclose=function(){return void r(),void v.emit([t,u.IDBEventType.destroy],new u.IDBEvent(u.IDBEventType.destroy,t)),void m(new y.End(t))},e.destroy=function(){return void r(),void n.close(),void f(new y.Destroy(t))},e.end=function(){return void r(),void n.close(),void m(new y.End(t))},e.drain=function(){var e=E.get(t)||[];try{for(;e.length>0&&0===l.get(t);)void e[0](n),void e.shift()}catch(e){e instanceof DOMException||e instanceof DOMError?void console.warn(e):void console.error(e),void r(),void c(new y.Crash(t,e))}},l.get(t)){case 0:var o=p.get(t).verify;try{if(!o(n))return void m(new y.End(t),n.version+1)}catch(e){return void c(new y.Crash(t,e))}return void v.emit([t,u.IDBEventType.connect],new u.IDBEvent(u.IDBEventType.connect,t)),void e.drain();case 1:return void e.end();case 2:return void e.destroy()}throw new TypeError("LocalSocket: Invalid command "+l.get(t)+".")}function i(e){var t=e.database,n=e.error,r=e.event;void r.preventDefault(),void v.emit([t,u.IDBEventType.error],new u.IDBEvent(u.IDBEventType.error,t));var o=p.get(t).destroy;return o(n,r)?void f(new y.Destroy(t)):void m(new y.End(t))}function a(e){var t=e.database,n=e.error,r=e.event;void r.preventDefault(),void v.emit([t,u.IDBEventType.abort],new u.IDBEvent(u.IDBEventType.abort,t));var o=p.get(t).destroy;return o(n,r)?void f(new y.Destroy(t)):void m(new y.End(t))}function c(e){var t=e.database,n=e.error;void v.emit([t,u.IDBEventType.crash],new u.IDBEvent(u.IDBEventType.crash,t));var r=p.get(t).destroy;return r(n,null)?void f(new y.Destroy(t)):void m(new y.End(t))}function f(e){var t=e.database,n=d.indexedDB.deleteDatabase(t);n.onsuccess=function(){return void E.delete(t),void v.emit([t,u.IDBEventType.destroy],new u.IDBEvent(u.IDBEventType.destroy,t)),void m(new y.End(t))},n.onerror=function(e){return void i(new y.Error(t,n.error,e))}}function m(e,t){var n=e.database;switch(void 0===t&&(t=0),void h.delete(n),l.get(n)){case 0:return void s(new y.Initial(n),t);case 1:return void l.delete(n),void p.delete(n),void v.emit([n,u.IDBEventType.disconnect],new u.IDBEvent(u.IDBEventType.disconnect,n));case 2:return void l.delete(n),void p.delete(n),void v.emit([n,u.IDBEventType.disconnect],new u.IDBEvent(u.IDBEventType.disconnect,n))}throw new TypeError("LocalSocket: Invalid command "+l.get(n)+".")}var b=e.database;void 0===t&&(t=0);p.get(b);try{var g=t?d.indexedDB.open(b,t):d.indexedDB.open(b),S=function(){return g.onupgradeneeded=void 0,g.onsuccess=void 0,g.onerror=void 0};g.onblocked=function(){return void n(new y.Block(b))},g.onupgradeneeded=function(){return void S(),void r(new y.Upgrade(b,g))},g.onsuccess=function(){return void S(),void o(new y.Success(b,g.result))},g.onerror=function(e){return void S(),void i(new y.Error(b,g.error,e))}}catch(e){void c(new y.Crash(b,e))}}var c=e("spica"),d=e("../module/global"),u=e("./event"),v=new c.Observable;n.event=v;var f,p=new Map,l=new Map;!function(e){e[e.open=0]="open",e[e.close=1]="close",e[e.destroy=2]="destroy"}(f||(f={}));var y,h=new Map;!function(e){var t=function(){function e(e){this.database=e,this.STATE,void h.set(e,this)}return e}();e.Initial=t;var n=function(){function e(e){this.database=e,this.STATE,void h.set(e,this)}return e}();e.Block=n;var r=function(){function e(e,t){this.database=e,this.session=t,this.STATE,void h.set(e,this)}return e}();e.Upgrade=r;var o=function(){function e(e,t){this.database=e,this.connection=t,this.STATE,void h.set(e,this)}return e}();e.Success=o;var i=function(){function e(e,t,n){this.database=e,this.error=t,this.event=n,this.STATE,void h.set(e,this)}return e}();e.Error=i;var a=function(){function e(e,t,n){this.database=e,this.error=t,this.event=n,this.STATE,void h.set(e,this)}return e}();e.Abort=a;var s=function(){function e(e,t){this.database=e,this.error=t,this.STATE,void h.set(e,this)}return e}();e.Crash=s;var c=function(){function e(e){this.database=e,this.STATE,void h.set(e,this)}return e}();e.Destroy=c;var d=function(){function e(e){this.database=e,this.STATE,void h.set(e,this)}return e}();e.End=d}(y||(y={}));var E=new Map;n.open=r,n.listen=o,n.close=i,n.destroy=a},{"../module/global":27,"./event":26,spica:void 0}],26:[function(e,t,n){"use strict";var r;!function(e){e.connect="connect",e.disconnect="disconnect",e.block="block",e.error="error",e.abort="abort",e.crash="crash",e.destroy="destroy"}(r=n.IDBEventType||(n.IDBEventType={}));var o=function(){function e(e,t){this.type=e,this.name=t,this.namespace=[this.name],void Object.freeze(this)}return e}();n.IDBEvent=o},{}],27:[function(e,t,n){"use strict";n.indexedDB=self.indexedDB,n.IDBKeyRange=self.IDBKeyRange;var r;!function(e){e.readonly="readonly",e.readwrite="readwrite"}(r=n.IDBTransactionMode||(n.IDBTransactionMode={}));var o;!function(e){e.next="next",e.nextunique="nextunique",e.prev="prev",e.prevunique="prevunique"}(o=n.IDBCursorDirection||(n.IDBCursorDirection={}))},{}],28:[function(e,t,n){"use strict";var r=e("./module/global");n.localStorage=r.localStorage,n.sessionStorage=r.sessionStorage,n.supportWebStorage=r.supportWebStorage;var o=e("./model/event");n.events=o.events},{"./model/event":29,"./module/global":30}],29:[function(e,t,n){"use strict";var r=e("spica"),o=e("../module/global"),i={localStorage:new r.Observable,sessionStorage:new r.Observable};n.events=i,void self.addEventListener("storage",function(e){switch(e.storageArea){case o.localStorage:return void i.localStorage.emit(["storage"],e);case o.sessionStorage:return void i.sessionStorage.emit(["storage"],e);default:return}})},{"../module/global":30,spica:void 0}],30:[function(e,t,n){"use strict";var r=e("spica");n.supportWebStorage=function(){try{var e="localsocket#"+r.uuid();if(void self.sessionStorage.setItem(e,e),e!==self.sessionStorage.getItem(e))throw 1;return void self.sessionStorage.removeItem(e),!0}catch(e){return!1}}(),n.localStorage=n.supportWebStorage?self.localStorage:void 0,n.sessionStorage=n.supportWebStorage?self.sessionStorage:void 0},{spica:void 0}],31:[function(e,t,n){"use strict";var r=e("../application/api");n.socket=r.socket,n.port=r.port,n.events=r.events,n.status=r.status},{"../application/api":5}],32:[function(e,t,n){"use strict";function r(){}n.noop=r},{}],localsocket:[function(e,t,n){"use strict";function r(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}r(e("./src/export"));var o=e("./src/export");n.default=o.default,n.__esModule=!0},{"./src/export":4}]},{},[1,2,3,"localsocket"]);